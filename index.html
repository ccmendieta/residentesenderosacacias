<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Residentes - Senderos de las Acacias</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #eef2f7; color: #2c3e50; }
    .hidden { display: none; }
    .card-panel { border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: none; padding: 35px; }
    .brand-logo { color: #1a237e; font-weight: 600; font-size: 1.8rem; margin-bottom: 0; }
    .sub-brand { font-size: 1.1rem; color: #5c6bc0; margin-top: 0; margin-bottom: 2rem; }
    .btn { border-radius: 12px; text-transform: none; font-weight: 600; height: 50px; box-shadow: none; }
    .indigo-dark { background-color: #1a237e !important; }
    .section-title { color: #5c6bc0; font-size: 1.2rem; margin-bottom: 25px; font-weight: 400; display: flex; justify-content: space-between; align-items: center; }
    .input-field input { border-bottom: 1px solid #e0e0e0 !important; font-size: 0.95rem !important; margin-bottom: 5px !important; }
    .input-field input:focus { border-bottom: 2px solid #1a237e !important; box-shadow: none !important; }
    .input-field label.active-label { position: static; font-size: 0.9rem; color: #2c3e50; font-weight: 400; margin-bottom: 5px; display: block; }
    
    /* Icono basurero */
    .delete-icon { color: #bdbdbd; cursor: pointer; transition: color 0.3s; }
    .delete-icon:hover { color: #e53935; }

    /* Contenedor teléfono con código de país */
    .phone-container { display: flex; gap: 10px; align-items: flex-end; }
    .country-code { width: 80px !important; text-align: center; }

    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .pass-container { position: relative; }
    .pass-container i { position: absolute; right: 10px; bottom: 15px; cursor: pointer; color: #9e9e9e; font-size: 20px; z-index: 5; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; display: none; }
    .vehiculo-card { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; }
  </style>
</head>
<body>
  <div class="progress" id="loader" style="margin:0;"><div class="indeterminate indigo"></div></div>

  <div class="container" style="max-width: 480px; margin-top: 5vh;">
    
    <div id="view-login" class="card-panel center-align">
      <h1 class="brand-logo">Gestión de Residentes</h1>
      <p class="sub-brand">Senderos de las Acacias</p>
      <div class="input-field">
        <input id="l-inm" type="text" maxlength="4" placeholder="Inmueble (Ej: A101)" oninput="this.value = this.value.toUpperCase()">
      </div>
      <div class="input-field">
        <input id="l-ced" type="number" placeholder="Cédula de Propietario" onkeypress="return event.charCode >= 48 && event.charCode <= 57">
      </div>
      <div class="pass-container input-field">
        <input id="l-pas" type="password" placeholder="Contraseña">
        <i class="material-icons" onclick="togglePass('l-pas')">visibility</i>
      </div>
      <button class="btn indigo-dark white-text w100" style="width:100%" onclick="login()">Iniciar Sesión</button>
      <button class="btn-flat indigo-text" style="text-decoration: underline; margin-top:15px;" onclick="ejecutarFlujoOlvido()">¿OLVIDÓ SU CONTRASEÑA?</button>
    </div>

    <div id="view-dash" class="hidden card-panel">
      <h5 class="center-align">Hola, <span id="dash-user" class="indigo-text"></span></h5>
      <p class="center-align grey-text" style="margin-bottom:30px">Inmueble: <span id="dash-inm"></span></p>
      <button class="btn white blue-text text-darken-4" style="border: 1px solid #2196f3; width:100%; margin-bottom:15px" onclick="showView('view-verify')">Verificar Información</button>
      <button class="btn white orange-text text-darken-4" style="border: 1px solid #ff9800; width:100%; margin-bottom:15px" onclick="showView('view-update')">Actualizar Datos</button>
      <button class="btn white purple-text text-darken-4" style="border: 1px solid #9c27b0; width:100%; margin-bottom:15px" onclick="showView('view-pass')">Cambiar de Contraseña</button>
      <button class="btn red lighten-5 red-text" style="width:100%; margin-top:20px" onclick="cerrarSesion()">Cerrar Sesión</button>
    </div>

    <div id="view-update" class="hidden card-panel">
      <div class="section-title">
        <span>Actualizar Datos</span>
        <i class="material-icons delete-icon" onclick="borrarTodoForm()">delete</i>
      </div>
      <div class="row" style="margin-bottom: 0;">
        <div id="form-residentes"></div>
        <div id="form-vehiculos"></div>
      </div>
      <div style="margin-top:40px; display: flex; gap: 10px;">
        <button class="btn orange darken-4 white-text" style="flex: 1;" onclick="valAndSave()">Actualizar</button>
        <button class="btn grey lighten-2 black-text" style="flex: 1;" onclick="showView('view-dash')">Volver</button>
      </div>
    </div>

    <div id="view-verify" class="hidden card-panel">
      <h5 class="section-title">Datos de Residentes</h5>
      <div id="verify-res-content"></div>
      <div class="divider-light"></div>
      <h5 class="section-title">Vehículos Registrados</h5>
      <div id="verify-veh-content"></div>
      <div style="margin-top:40px; display: flex; gap: 10px;">
        <button class="btn orange darken-4 white-text" style="flex: 1;" onclick="showView('view-update')">Actualizar</button>
        <button class="btn grey lighten-2 black-text" style="flex: 1;" onclick="showView('view-dash')">Volver</button>
      </div>
    </div>

    <div id="view-pass" class="hidden card-panel">
      <h5 class="section-title">Cambiar Contraseña</h5>
      <div class="pass-container input-field"><input id="p-new" type="password" placeholder="Nueva"><i class="material-icons" onclick="togglePass('p-new')">visibility</i></div>
      <div class="pass-container input-field"><input id="p-confirm" type="password" placeholder="Confirmar"><i class="material-icons" onclick="togglePass('p-confirm')">visibility</i></div>
      <div class="input-field"><input id="p-tel" type="text" placeholder="Teléfono"></div>
      <div class="input-field"><input id="p-ema" type="email" placeholder="Email"></div>
      <button class="btn orange darken-4 white-text w100" style="width:100%" onclick="submitPass()">Actualizar</button>
    </div>
    
    <div id="view-forgot" class="hidden card-panel center-align"><i class="material-icons large indigo-text">lock_outline</i><h5>Atención</h5><p>Consulte a la administración.</p></div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyWaG0kxUdrU8fGQyTaYatqocGyXWngsjRXyf-RwIG50XqVuvq657o2RqKqrcRrTek1/exec"; 
    let sess = { row: null, user: null };

    /**
     * RENDERIZADO DINÁMICO
     * 1.1 Inclusión de Código de País (+57) y campo teléfono de 10 dígitos.
     */
    const resForm = document.getElementById('form-residentes');
    for(let i=1; i<=5; i++) {
      resForm.innerHTML += `
        <div class="input-field col s12" style="margin-top: 10px;">
          <label class="active-label">Residente ${i === 1 ? 'Principal' : i}</label>
          <input id="u-res${i}" type="text" placeholder="Nombre completo" oninput="this.value = this.value.toUpperCase()">
        </div>
        <div class="col s12">
          <label class="active-label">Teléfono</label>
          <div class="phone-container">
            <input id="u-cod${i}" type="text" class="country-code" value="+57" placeholder="+00">
            <input id="u-tel${i}" type="number" style="flex:1" placeholder="3000000000" onkeypress="return this.value.length < 10">
          </div>
        </div>`;
    }

    const vForm = document.getElementById('form-vehiculos');
    for(let i=1; i<=5; i++) {
      vForm.innerHTML += `
        <div class="col s12 vehiculo-card">
          <label class="blue-text" style="font-weight:600">Vehículo ${i}</label>
          <select id="u-t${i}" class="browser-default" style="margin: 10px 0; border: 1px solid #ddd; border-radius: 8px;">
            <option value="">-- Tipo --</option>
            <option value="MOTOCICLETA">MOTOCICLETA</option>
            <option value="AUTOMÓVIL">AUTOMÓVIL</option>
            <option value="CAMIONETA">CAMIONETA</option>
          </select>
          <input id="u-p${i}" type="text" maxlength="6" placeholder="Placa" oninput="this.value = this.value.toUpperCase()">
        </div>`;
    }

    async function callAPI(payload) {
      document.getElementById('loader').style.display = 'block';
      try {
        const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
        return await response.json();
      } catch (e) { alert("Error de red."); return { success: false }; }
      finally { document.getElementById('loader').style.display = 'none'; }
    }

    async function login() {
      const inm = document.getElementById('l-inm').value.toUpperCase(), ced = document.getElementById('l-ced').value, pas = document.getElementById('l-pas').value;
      if(!/^[A-J][0-9]{3}$/.test(inm)) return alert("Inmueble inválido (Ej: A101).");
      const res = await callAPI({ action: 'login', inmueble: inm, cedula: ced, password: pas });
      if(res.success) { sess = { row: res.rowIndex, user: res.userData }; showView('view-dash'); } 
      else alert(res.message);
    }

    /**
     * VALIDACIÓN Y GUARDADO
     * 1.1 Regla: Colombia (+57) debe empezar por 3 y tener 10 dígitos.
     */
    async function valAndSave() {
      const d = {};
      for(let i=1; i<=5; i++) {
        const n = document.getElementById('u-res'+i).value.trim();
        const t = document.getElementById('u-tel'+i).value.trim();
        const c = document.getElementById('u-cod'+i).value.trim();

        if((n && !t) || (!n && t)) { alert("Residente "+i+": Complete nombre y teléfono."); return; }
        
        if(t) {
          if(t.length !== 10) { alert("Teléfono Residente "+i+": Debe tener 10 dígitos."); return; }
          if(c === "+57" && t[0] !== "3") { alert("Teléfono Colombia debe iniciar con 3."); return; }
          d['telR'+i] = "(" + c + ") " + t;
        } else { d['telR'+i] = ""; }
        d['res'+i] = n;
      }

      for(let i=1; i<=5; i++) {
        const tipo = document.getElementById('u-t'+i).value, placa = document.getElementById('u-p'+i).value.trim();
        if((tipo && !placa) || (!tipo && placa)) { alert("Vehículo "+i+": Complete tipo y placa."); return; }
        if(placa) {
          const reg = tipo === "MOTOCICLETA" ? /^[A-Z]{3}[0-9]{2}[A-Z]$/ : /^[A-Z]{3}[0-9]{3}$/;
          if(!reg.test(placa)) { alert("Placa "+i+" formato inválido."); return; }
        }
        d['t'+i] = tipo; d['p'+i] = placa;
      }

      if(!d.res1 && !d.telR1) {
        if(!confirm("Se restaurará al Propietario. ¿Continuar?")) return;
        d.res1 = sess.user.nombre; d.telR1 = sess.user.telProp;
      }

      const res = await callAPI({ action: 'update', rowIndex: sess.row, data: d });
      if(res.success) { sess.user = {...sess.user, ...d}; showView('view-dash'); alert("Guardado."); }
    }

    /**
     * 1.2 FUNCIÓN BORRAR TODO EL FORMULARIO
     */
    function borrarTodoForm() {
      if(!confirm("¿Desea limpiar todos los campos del formulario?")) return;
      for(let i=1; i<=5; i++) {
        document.getElementById('u-res'+i).value = "";
        document.getElementById('u-tel'+i).value = "";
        document.getElementById('u-cod'+i).value = "+57";
        document.getElementById('u-t'+i).value = "";
        document.getElementById('u-p'+i).value = "";
      }
    }

    function renderVerify() {
      const u = sess.user;
      let r = "", v = "";
      for(let i=1; i<=5; i++) if(u['res'+i]) r += `<div class="data-group"><span class="data-label">Residente ${i}: ${u['res'+i]}</span><span class="data-sublabel">Tel: ${u['telR'+i]}</span></div>`;
      for(let i=1; i<=5; i++) if(u['p'+i]) v += `<div class="data-group"><span class="data-label">Vehículo ${i}: ${u['t'+i]} [${u['p'+i]}]</span></div>`;
      document.getElementById('verify-res-content').innerHTML = r || "Sin datos.";
      document.getElementById('verify-veh-content').innerHTML = v || "Sin datos.";
    }

    function fillUpdate() {
      const u = sess.user;
      for(let i=1; i<=5; i++) {
        document.getElementById('u-res'+i).value = u['res'+i] || "";
        const telFull = u['telR'+i] || "";
        if(telFull.includes(")")) {
          document.getElementById('u-cod'+i).value = telFull.split(")")[0].replace("(","");
          document.getElementById('u-tel'+i).value = telFull.split(")")[1].trim();
        } else {
          document.getElementById('u-cod'+i).value = "+57";
          document.getElementById('u-tel'+i).value = telFull;
        }
        document.getElementById('u-t'+i).value = u['t'+i] || "";
        document.getElementById('u-p'+i).value = u['p'+i] || "";
      }
    }

    function showView(id) {
      document.querySelectorAll('.container > div:not(#loader)').forEach(v => v.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id === 'view-verify') renderVerify();
      if(id === 'view-update') fillUpdate();
    }

    function togglePass(id) { const x = document.getElementById(id); x.type = x.type === "password" ? "text" : "password"; }
    function cerrarSesion() { location.reload(); }
    function ejecutarFlujoOlvido() { showView('view-forgot'); setTimeout(cerrarSesion, 6000); }
  </script>
</body>
</html>
