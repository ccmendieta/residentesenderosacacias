<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Residentes - Senderos de las Acacias</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: #eef2f7; color: #2c3e50; }
    .hidden { display: none; }
    .card-panel { border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none; padding: 25px; }
    .brand-logo { color: #1a237e; font-weight: 600; font-size: 1.8rem; margin-bottom: 0; }
    .sub-brand { font-size: 1.1rem; color: #5c6bc0; margin-top: 0; margin-bottom: 2rem; }
    .btn { border-radius: 8px; text-transform: none; font-weight: 500; height: 45px; box-shadow: none; width: 100%; margin-bottom: 10px; }
    .indigo-dark { background-color: #1a237e !important; }
    .vehiculo-card { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e0e0e0; position: relative; }
    .verify-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    #loader { position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; display: none; }
    .pass-container { position: relative; }
    .pass-container i { position: absolute; right: 10px; top: 15px; cursor: pointer; color: #9e9e9e; }
    input::placeholder { color: #9e9e9e; }
  </style>
</head>
<body>
  <div class="progress" id="loader" style="margin:0;"><div class="indeterminate indigo"></div></div>

  <div class="container" style="max-width: 500px; margin-top: 5vh;">
    
    <div id="view-login" class="card-panel center-align">
      <h1 class="brand-logo">Gestión Residentes</h1>
      <p class="sub-brand">Senderos de las Acacias</p>
      <div class="input-field"><input id="l-inm" type="text" placeholder="Inmueble (Ej: A101)"></div>
      <div class="input-field"><input id="l-ced" type="number" placeholder="Cédula de Propietario"></div>
      <div class="input-field"><input id="l-pas" type="password" placeholder="Contraseña"></div>
      <button class="btn indigo-dark" onclick="login()">Iniciar Sesión</button>
      <button class="btn-flat indigo-text" style="text-decoration: underline;" onclick="ejecutarFlujoOlvido()">¿Olvidó su contraseña?</button>
    </div>

    <div id="view-forgot" class="hidden card-panel center-align">
      <i class="material-icons large indigo-text">lock_outline</i>
      <h5>Atención</h5>
      <p>Para recuperar su acceso debe solicitar el cambio de contraseña al correo de la administración.</p>
      <div class="progress"><div class="indeterminate indigo"></div></div>
      <p class="grey-text small">Redirigiendo al login en 5 segundos...</p>
    </div>

    <div id="view-dash" class="hidden card-panel">
      <h5 class="center-align">Hola, <span id="dash-user" class="indigo-text"></span></h5>
      <p class="center-align grey-text">Inmueble: <span id="dash-inm"></span></p>
      <div style="margin-top:30px">
        <button class="btn white blue-text text-darken-4" style="border: 1px solid #2196f3;" onclick="showView('view-verify')">Verificar Información</button>
        <button class="btn white orange-text text-darken-4" style="border: 1px solid #ff9800;" onclick="showView('view-update')">Actualizar Datos</button>
        <button class="btn white purple-text text-darken-4" style="border: 1px solid #9c27b0;" onclick="showView('view-pass')">Seguridad / Contraseña</button>
        <button class="btn red lighten-5 red-text" style="margin-top:20px" onclick="cerrarSesion()">Cerrar Sesión</button>
      </div>
    </div>

    <div id="view-verify" class="hidden card-panel">
      <h6 class="indigo-text font-weight-bold">Residentes Actuales</h6>
      <div id="verify-res" class="verify-item"></div>
      <h6 class="indigo-text font-weight-bold" style="margin-top:20px">Vehículos en Sistema</h6>
      <div id="verify-veh"></div>
      <div style="margin-top:25px">
        <button class="btn orange darken-3" onclick="showView('view-update')">Ir a Actualizar</button>
        <button class="btn grey lighten-2 black-text" onclick="showView('view-dash')">Volver</button>
      </div>
    </div>

    <div id="view-update" class="hidden card-panel">
      <h6 class="indigo-text">Actualizar Residentes</h6>
      <div class="row">
        <div class="input-field col s12"><input id="u-res1" type="text" placeholder="Nombre Residente 1"></div>
        <div class="input-field col s12"><input id="u-tel1" type="text" placeholder="Teléfono Residente 1"></div>
        <div class="input-field col s12"><input id="u-res2" type="text" placeholder="Nombre Residente 2"></div>
        <div class="input-field col s12"><input id="u-tel2" type="text" placeholder="Teléfono Residente 2"></div>
        <div id="form-vehiculos"></div>
      </div>
      <button class="btn green darken-2" onclick="valAndSave()">Guardar Cambios</button>
      <button class="btn grey lighten-2 black-text" onclick="showView('view-dash')">Cancelar</button>
    </div>

    <div id="view-pass" class="hidden card-panel">
      <h6 class="indigo-text">Seguridad de la Cuenta</h6>
      <p class="small grey-text">Valide sus datos registrados para cambiar la clave.</p>
      <div class="pass-container input-field">
        <input id="p-new" type="password" placeholder="Nueva Contraseña (min 8 car.)">
        <i class="material-icons" onclick="togglePass('p-new')">visibility</i>
      </div>
      <div class="input-field"><input id="p-tel" type="text" placeholder="Teléfono Propietario Registrado"></div>
      <div class="input-field"><input id="p-ema" type="email" placeholder="Email Propietario Registrado"></div>
      <button class="btn indigo-dark" onclick="submitPass()">Actualizar Contraseña</button>
      <button class="btn-flat grey-text" onclick="showView('view-dash')">Volver</button>
    </div>

  </div>

  <script>
    // URL DE TU GOOGLE APPS SCRIPT INTEGRADA
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxPd3-io_WZKtPW16jWzUVTeMRrHhSMNrFqUm3lPFtB7lsChDSe2LfiTDyp2HObZ33n/exec"; 

    let sess = { row: null, user: null };

    // Inicializar campos de vehículos dinámicamente
    const vForm = document.getElementById('form-vehiculos');
    for(let i=1; i<=4; i++) {
      vForm.innerHTML += `
        <div class="col s12 vehiculo-card">
          <label class="blue-text">Vehículo ${i}</label>
          <select id="u-t${i}" class="browser-default" style="margin-bottom:10px; border: 1px solid #ddd; border-radius:4px;">
            <option value="">-- Seleccione Tipo --</option>
            <option value="MOTOCICLETA">MOTOCICLETA</option>
            <option value="AUTOMÓVIL">AUTOMÓVIL</option>
            <option value="CAMIONETA">CAMIONETA</option>
          </select>
          <input id="u-p${i}" type="text" maxlength="6" placeholder="Placa ${i}" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
        </div>`;
    }

    // COMUNICACIÓN CON EL BACKEND (Google Apps Script)
    async function callAPI(payload) {
      document.getElementById('loader').style.display = 'block';
      try {
        // GAS requiere 'follow' en redirects y el método POST suele ser tratado de forma especial
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await response.json();
        return data;
      } catch (e) {
        console.error("Error API:", e);
        return { success: false, message: "Error de conexión con el servidor. Verifique su internet." };
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    // FLUJO LOGIN
    async function login() {
      const inm = document.getElementById('l-inm').value.toUpperCase();
      const ced = document.getElementById('l-ced').value;
      const pas = document.getElementById('l-pas').value;

      if(!inm || !ced || !pas) return alert("Complete todos los campos.");

      const res = await callAPI({ action: 'login', inmueble: inm, cedula: ced, password: pas });
      
      if(res.success) {
        sess = { row: res.rowIndex, user: res.userData };
        document.getElementById('dash-user').innerText = res.userData.nombre;
        document.getElementById('dash-inm').innerText = res.userData.inmueble;
        showView('view-dash');
      } else {
        alert(res.message || "Error de credenciales.");
      }
    }

    // FLUJO GUARDAR DATOS
    async function valAndSave() {
      const d = {
        res1: document.getElementById('u-res1').value, telR1: document.getElementById('u-tel1').value,
        res2: document.getElementById('u-res2').value, telR2: document.getElementById('u-tel2').value,
        t1: document.getElementById('u-t1').value, p1: document.getElementById('u-p1').value,
        t2: document.getElementById('u-t2').value, p2: document.getElementById('u-p2').value,
        t3: document.getElementById('u-t3').value, p3: document.getElementById('u-p3').value,
        t4: document.getElementById('u-t4').value, p4: document.getElementById('u-p4').value
      };

      const res = await callAPI({ action: 'update', rowIndex: sess.row, data: d });
      if(res.success) {
        alert("¡Datos actualizados correctamente!");
        sess.user = {...sess.user, ...d};
        showView('view-dash');
      } else {
        alert("Error al guardar: " + res.message);
      }
    }

    // FLUJO CAMBIO CONTRASEÑA
    async function submitPass() {
      const n1 = document.getElementById('p-new').value;
      const tel = document.getElementById('p-tel').value;
      const ema = document.getElementById('p-ema').value;

      if(n1.length < 8) return alert("La contraseña debe tener al menos 8 caracteres.");

      const res = await callAPI({ 
        action: 'changePass', 
        rowIndex: sess.row, 
        newPass: n1, 
        tel: tel, 
        email: ema 
      });

      if(res.success) {
        alert("Contraseña actualizada con éxito. Inicie sesión nuevamente.");
        cerrarSesion();
      } else {
        alert("Validación fallida: El teléfono o email no coinciden con los del propietario.");
      }
    }

    // UTILIDADES DE NAVEGACIÓN
    function showView(id) {
      document.querySelectorAll('.container > div:not(#loader)').forEach(v => v.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id === 'view-verify') renderVerify();
      if(id === 'view-update') fillUpdate();
    }

    function renderVerify() {
      const u = sess.user;
      document.getElementById('verify-res').innerHTML = `
        <p><b>Residente 1:</b> ${u.res1 || '---'} <br> <small>Tel: ${u.telR1 || '---'}</small></p>
        <p><b>Residente 2:</b> ${u.res2 || '---'} <br> <small>Tel: ${u.telR2 || '---'}</small></p>`;
      
      let vehs = "";
      for(let i=1; i<=4; i++) {
        if(u['p'+i]) vehs += `<p class="verify-item"><b>${u['t'+i]}:</b> ${u['p'+i]}</p>`;
      }
      document.getElementById('verify-veh').innerHTML = vehs || '<p class="orange-text">Sin vehículos registrados.</p>';
    }

    function fillUpdate() {
      const u = sess.user;
      document.getElementById('u-res1').value = u.res1 || "";
      document.getElementById('u-tel1').value = u.telR1 || "";
      document.getElementById('u-res2').value = u.res2 || "";
      document.getElementById('u-tel2').value = u.telR2 || "";
      for(let i=1; i<=4; i++) {
        document.getElementById('u-t'+i).value = u['t'+i] || "";
        document.getElementById('u-p'+i).value = u['p'+i] || "";
      }
    }

    function togglePass(id) {
      const input = document.getElementById(id);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function cerrarSesion() { location.reload(); }

    function ejecutarFlujoOlvido() {
      showView('view-forgot');
      setTimeout(() => { showView('view-login'); }, 5000);
    }
  </script>
</body>
</html>